<script type="text/x-template" id="sec-madrec">
    <div class="container fixed-center">
        <div class="card card-sec border-0" v-if="$root.store.user.dcapps.madrec.data.accessStatus=='denied'">
            <div class="card-header">
                <h4><i class="fas fa-chart-pie fa-fw mr-2 text-sec"></i>MADRec DCApp</h4>
                <p class="mb-0">Collectively measure reference data quality</p>
            </div>
            <div class="card-body">
                <div class="py-2">
                    <h6 class="card-title">Restricted access</h6>
                    <p class="card-text">This DCApp is private and requires new members to be co-opted.</p>
                </div>
                <hr class="my-3 sec" />
                <div class="py-2">
                    <h6 class="card-title">Identification required</h6>
                    <p class="card-text mb-4">
                        Current members of the MADRec app need minimal information about you to grant you access.<br/>
                        Please grant MADRec access to the personal information listed below.
                    </p>
                    <div v-if="!records.hasEnough">
                        <p class="card-text">MADRec would like to access to some of your personal records that you haven't filled yet</p>
                        <ul class="list-group" style="max-width: 400px;">
                            <li class="list-group-item">
                                <i v-if="!records.hasFirstname" class="fas fa-exclamation-triangle fa-fw mr-2 text-danger"></i>
                                <i v-else class="fas fa-check fa-fw mr-2 text-primary"></i>
                                Firstname
                            </li>
                            <li class="list-group-item">
                                <i v-if="!records.hasLastname" class="fas fa-exclamation-triangle fa-fw mr-2 text-danger"></i>
                                <i v-else class="fas fa-check fa-fw mr-2 text-primary"></i>
                                Lastname
                            </li>
                            <li class="list-group-item">
                                <i v-if="!records.hasPhoneVerified&&!records.hasEmailVerified" class="fas fa-exclamation-triangle fa-fw mr-2 text-danger"></i>
                                <i v-else class="fas fa-check fa-fw mr-2 text-primary"></i>
                                Verified phone and/or email
                            </li>
                        </ul>
                        <router-link to="/me" class="btn btn-sec mt-4" tag="button">Update my profile</router-link>
                    </div>
                    <div v-else>
                        <p class="card-text">MADRec would like to access to some of your personal records</p>
                        <div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="firstname" id="madrec_ra_firstname" checked="checked" disabled>
                                <label class="form-check-label" for="madrec_ra_firstname">First name</label>
                            </div>
                            <div class="form-check mt-1">
                                <input class="form-check-input" type="checkbox" value="lastname" id="madrec_ra_lastname" checked="checked" disabled>
                                <label class="form-check-label" for="madrec_ra_lastname">Last name</label>
                            </div>
                            <div class="form-check mt-1">
                                <input class="form-check-input" type="checkbox" value="phone" id="madrec_ra_phone" :checked="records.hasPhoneVerified">
                                <label class="form-check-label" for="madrec_ra_phone">
                                    Phone <i v-if="records.hasPhoneVerified" class="fas fa-check-circle text-primary"></i>
                                </label>
                            </div>
                            <div class="form-check mt-1">
                                <input class="form-check-input" type="checkbox" value="email" id="madrec_ra_email" :checked="records.hasEmailVerified">
                                <label class="form-check-label" for="madrec_ra_email">
                                    Email <i v-if="records.hasEmailVerified" class="fas fa-check-circle text-primary"></i>
                                </label>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-sec" @click.prevent="requestAccess">Share personal records and request access</button>
                                <sec-notif-state :state="nsRequest.data"></sec-notif-state>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card card-sec border-0 mb-4" v-else-if="$root.store.user.dcapps.madrec.data.accessStatus=='requested'">
            <div class="card-header">
                <h4><i class="fas fa-chart-pie fa-fw mr-2 text-sec"></i>Interract with MADRec</h4>
                <p class="mb-0">Collectively measure reference data quality</p>
            </div>
            <div class="card-body">
                <h6 class="card-title">Restricted access</h6>
                <p class="card-text">Your request to join MADRec has been registered.</p>
                <p class="card-text">Waiting for {{1-$root.store.user.dcapps.madrec.data.grants}} MADRec participant to grant you access.</p>
            </div>
        </div>
        <div class="row" v-else-if="$root.store.user.dcapps.madrec.data.accessStatus=='granted'">
            <div class="col-2">
                <div class="list-group">
                    <router-link :to="'/app/madrec/members'" class="list-group-item list-group-item-action" active-class="active"><i class="fas fa-user fa-fw mr-2"></i><span>Members</span><span v-if="requestingMembers > 0" class="badge badge-info ml-1 badge-top">{{requestingMembers}}</span></router-link>
                    <router-link :to="'/app/madrec/single-lei'" class="list-group-item list-group-item-action" active-class="active"><i class="fas fa-chart-pie fa-fw mr-2"></i><span>Single LEI</span></router-link>
                    <router-link :to="'/app/madrec/multi-lei'" class="list-group-item list-group-item-action" active-class="active"><i class="fas fa-file-upload fa-fw mr-2"></i><span>Multi LEI</span></router-link>
                    <router-link :to="'/app/madrec/reports'" class="list-group-item list-group-item-action" active-class="active"><i class="fas fa-chart-bar fa-fw mr-2"></i><span>Reports</span></router-link>
                </div>
            </div>
            <div class="col-10">
                <router-view></router-view>
            </div>
        </div>
    </div>
    </div>
</script>

<script type="text/x-template" id="sec-madrec-members">
    <div class="card card-sec border-0">
        <div class="card-header">
            <h4><i class="fas fa-user fa-fw mr-2 text-sec"></i>MADRec members</h4>
        </div>
        <div class="card-body">
            <h6 class="card-title">All MADRec members</h6>
            <table class="table table-sm table-hover mt-3">
                <thead>
                    <tr>
                        <th scope="col">Firstname</th>
                        <th scope="col">Lastname</th>
                        <th scope="col">Phone</th>
                        <th scope="col">Email</th>
                        <th scope="col">Status</th>
                        <th scope="col"></th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="p in members">
                        <td>
                            {{p.firstname}}
                        </td>
                        <td>
                            {{p.lastname}}
                        </td>
                        <td>
                            {{p.phone}} <i v-if="p.phoneVerified" class="fas fa-check-circle text-primary"></i>
                        </td>
                        <td>
                            {{p.email}} <i v-if="p.emailVerified" class="fas fa-check-circle text-primary"></i>
                        </td>
                        <td>
                            {{p.status}} <span v-if="p.status=='requested'" class="badge badge-warning">{{p.grants}}</span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sec btn-sm" @click.prevent="vote('granted', p.cooptionId)" v-if="!p.isSelf&&p.vote!='granted'">Grant</button>
                            <span v-if="p.isSelf">(you)</span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" @click.prevent="vote('denied', p.cooptionId)" v-if="!p.isSelf&&p.vote!='denied'">Deny</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <sec-notif-state :state="ns.data"></sec-notif-state>
        </div>
    </div>
</script>

<script type="text/x-template" id="sec-madrec-single-lei">
    <div class="card card-sec border-0">
        <div class="card-header">
            <h4><i class="fas fa-chart-pie fa-fw mr-2 text-sec"></i>Single LEI report</h4>
        </div>
        <div class="card-body">
            <h6 class="card-title">Select an LEI</h6>
            <div class="mt-2 form-inline form-madrec">
                <label for="madrecSingleLei">{{lei.name}}</label>
                <input type="text" class="form-control" id="madrecSingleLei" :placeholder="lei.name" :value="useSample?lei.sample:''">
            </div>
            <hr />
            <h6 class="card-title">Fill fields values</h6>
            <div v-for="(f, i) in fields" :key="f.name" class="form-inline form-madrec">
                <label :for="'madrecSingle-'+i">{{f.name}}</label>
                <input v-if="f.type=='text'" type="text" :id="'madrecSingle-'+i" :placeholder="f.name"
                    :value="useSample?f.sample:''" class="form-control">
                <select v-else-if="f.type=='list'" class="form-control" :id="'madrecSingle-'+i">
                    <option value="-1"></option>
                    <option v-for="(el, idx) in f.values" :value="idx" :selected="useSample&&f.sample==el">{{el}}</option>
                </select>
                <select v-else-if="f.type=='bool'" class="form-control" :id="'madrecSingle-'+i">
                    <option value="-1"></option>
                    <option v-for="(el, idx) in ['Y','N']" :value="idx" :selected="useSample&&f.sample==el">{{el}}</option>
                </select>
            </div>
            <div class="mt-4 mb-2 form-inline form-madrec">
                <label for="madrecSingleLei">Select one hashing options</label>
                <select class="form-control" id="madrecSingleHashOpt">
                    <option value="1">Do not hash</option>
                    <option value="2" selected>Hash</option>
                </select>
            </div>
            <div>
                <div class="mt-3">
                    <button type="button" class="btn btn-sec" @click.prevent="madrecPut">Contribute</button>
                    <sec-notif-state :state="nsPut.data"></sec-notif-state>
                </div>
                <div class="mt-2 alert alert-warning alert-dismissible fade show" role="alert" v-if="warnings.length>0">
                    <div v-for="warning in warnings" class="warning">{{warning}}</div>
                    <button type="button" class="close" aria-label="Close" @click="warnings=[]">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
            <div class="mt-4">
                <hr />
                <h6 class="card-title">LEI report</h6>
                <div class="mt-2">
                    <button type="button" class="btn btn-sec mr-3" @click.prevent="madrecGet">Get report</button>
                    <sec-notif-state :state="nsGet.data"></sec-notif-state>
                    <a v-if="exportableResults.length>0" class="btn btn-sec btn-sm float-right" :href="resultsExportUrl" download="single-LEI-report.json">Export</a>
                </div>
                <div class="madrec-pie-report card mt-3 mr-3" style="display: inline-block;" v-for="(item, name) in results" :key="name" >
                    <div class="card-header text-center">{{name}}</div>
                    <div class="card-body p-2" style="position:relative;">
                        <pie-chart :data="item.groups" :colors="item.colors"></pie-chart>
                        <div class="ml-1 mt-2">
                            <div class="text-nowrap">Contrib: {{item.contribution}}</div>
                            <div class="text-nowrap">Total: {{item.total}}</div>
                            <div class="text-nowrap">
                                <span :style="{ borderBottom: '4px solid ' + item.color }" style ="display: inline-block; line-height: 12px;">Group: {{item.groups[item.group]}}</span>
                            </div>
                            <div class="text-nowrap">Split: {{JSON.stringify(item.groups)}}</div>
                        </div>
                    </div>
                    <div class="card-footer text-center p-1">
                        {{item.report}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" id="sec-madrec-multi-lei">
    <div class="card card-sec border-0">
        <div class="card-header">
            <h4><i class="fas fa-file-upload fa-fw mr-2 text-sec"></i>Multi LEI report</h4>
        </div>
        <div class="card-body">
            <h6 class="card-title">Push multiple LEIs to MADRec</h6>
            <div class="alert alert-primary alert-dismissible fade show" role="alert" v-if="!hasFile">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <p>Please find the <a href="https://github.com/Secretarium/MADRec/wiki/Instructions#madrec" target="_blank">instructions</a> on Github.</P>
                <?php if($is_test_env) { ?>
                <p class="mb-0">Want to test ? Please use the samples:</p>
                <a class="btn btn-sec btn-sm mt-1 mr-2" href="/downloads/sample.250.csv" download="sample.250.csv">250 LEIs</a>
                <a class="btn btn-sec btn-sm mt-1 mr-2" href="/downloads/sample.20000.csv" download="sample.20000.csv">20k LEIs</a>
                <a class="btn btn-sec btn-sm mt-1 mr-2" href="/downloads/sample.100000.csv" download="sample.100000.csv">100k LEIs</a>
                <a class="btn btn-sec btn-sm mt-1 mr-2" href="/downloads/sample.500000.csv" download="sample.500000.csv">500k LEIs</a>
                <a class="btn btn-sec btn-sm mt-1 mr-2" href="/downloads/sample.1325966.csv" download="sample.1325966.csv">1.3M+ LEIs</a>
                <?php } ?>
            </div>
            <p class="card-text mt-3 mb-0" data-toggle="collapse" href="#madrec-multi-lei-load-file-wrap" role="button" aria-expanded="true" aria-controls="madrec-multi-lei-load-file-wrap">
                <span v-if="hasFile">
                    <i class="fas fa-check text-success fa-fw mr-2"></i>
                    File "{{file.name}}" ({{humanFileSize(file.size)}}) successfully loaded
                </span>
                <span v-else>Please browse for your local MADRec csv file or drop it here</span>
            </p>
            <div class="collapse" :class="{show:!hasFile}" id="madrec-multi-lei-load-file-wrap">
                <div class="custom-file mt-3">
                    <input type="file" class="custom-file-input" id="madrecCsvFile" accept=".csv" @change="csvFileChange">
                    <label class="custom-file-label" for="madrecCsvFile">Browse</label>
                </div>
                <p v-if="fileMsg.length>0" class="small text-muted">
                    {{fileMsg}}
                </p>
            </div>
            <div v-if="hasFile&&!verify.done" class="mt-3">
                <p class="card-text" v-if="fileMsg.length>0">
                    <i class="fas fa-exclamation-circle text-primary fa-fw mr-2"></i>
                    {{fileMsg}}
                </p>
                <p class="card-text">
                    <i class="fas fa-hourglass-start text-warning fa-fw mr-2"></i>
                    Verifying "{{file.name}}" data formats
                </p>
                <p class="card-text" v-if="verify.msg.length>0">
                    {{verify.msg}}
                </p>
                <div class="progress mt-3" style="height: 5px;">
                    <div class="progress-bar no-transition bg-success" role="progressbar" :aria-valuenow="verifyBar.verified" aria-valuemin="0" aria-valuemax="100" :style="{'width': `${verifyBar.verified}%`}"></div>
                    <div class="progress-bar no-transition bg-secondary" role="progressbar" :aria-valuenow="verifyBar.read" aria-valuemin="0" aria-valuemax="100" :style="{'width': `${verifyBar.read}%`}"></div>
                </div>
            </div>
            <div v-else-if="verify.done" class="mt-3">
                <p class="card-text">
                    <i class="fas fa-check text-success fa-fw mr-2"></i>
                    All {{rowsCount}} LEIs and associated fields have been successfully verified
                </p>
                <p class="card-text" v-if="upload.done">
                    <i class="fas fa-check text-success fa-fw mr-2"></i>
                    All {{rowsCount}} LEIs have been successfully uploaded
                </p>
                <div class="mt-2 alert alert-warning alert-dismissible fade show" role="alert" v-if="verify.warnings.length>0">
                    <div v-for="warning in verify.warnings" class="warning">{{warning}}</div>
                    <button type="button" class="close" aria-label="Close" @click="verify.warnings=[]">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div v-if="!upload.done" class="mt-4">
                    <p class="card-text mt-2 mb-2">Please select one of the hashing options:</p>
                    <select class="custom-select" style="width: 350px;" id="madrecMultiPutHash">
                        <option value="1" v-if="!verify.isHashed">Do not hash</option>
                        <option value="2" v-if="!verify.isHashed" selected>Hash</option>
                        <option value="3" v-if="verify.isHashed===true">Already hashed</option>
                    </select>
                    <div class="mt-3">
                        <button v-if="upload.verify.showRetry" type="button" class="btn btn-sec" @click.prevent="retryMissing">Retry the {{rowsCount - upload.executed}} missing LEIs</button>
                        <button v-else type="button" class="btn btn-sec" @click.prevent="uploadFile" :disabled="upload.showProgress">Start upload</button>
                        <span class="small text-muted ml-3">
                            {{upload.msg}}
                        </span>
                    </div>
                </div>
                <div class="progress mt-3 mb-3" v-if="upload.showProgress" style="height: 5px;">
                    <div class="progress-bar no-transition" role="progressbar" aria-valuemin="0" aria-valuemax="100"
                        v-for="b in upload.blocks"
                        :class="[b.class]"
                        :aria-valuenow="b.items*100.0/rowsCount"
                        :style="{'width': `${b.items*100.0/rowsCount}%`}"
                        :title="b.title">
                    </div>
                </div>
                <p class="card-text" v-if="upload.verify.counter>0">
                    {{upload.verify.issueMsg}}
                </p>
                <router-link v-if="upload.done" to="/app/madrec/reports" class="btn btn-success btn mt-3" tag="button">View reports</router-link>
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" id="sec-madrec-report">
    <div class="card card-sec border-0">
        <div class="card-header">
            <h4><i class="fas fa-chart-bar fa-fw mr-2 text-sec"></i>Global report</h4>
        </div>
        <div class="card-body">
            <h6 class="card-title">Personal report</h6>
            <p class="card-text">Your MADRec personal report
                <sec-notif-state :state="nsUserReport.data"></sec-notif-state>
                <a v-show="personalReport.length>0" class="btn btn-sec btn-sm float-right" style="margin-top: -0.25em;" :href="personalReportExportUrl" download="personal-report.json">Export</a>
            </p>
            <div class="mt-2">
                <div style="position: relative;">
                    <canvas id="madrec-user-report"></canvas>
                </div>
            </div>
            <hr />
            <h6 class="card-title">Consortium report</h6>
            <p class="card-text">The MADRec consortium report
                <sec-notif-state :state="nsConsortiumReport.data"></sec-notif-state>
                <a v-show="consortiumReport.length>0" class="btn btn-sec btn-sm float-right" style="margin-top: -0.25em;" :href="consortiumReportExportUrl" download="consortium-report.json">Export</a>
            </p>
            <div class="mt-2">
                <div style="position: relative;">
                    <canvas id="madrec-consortium-report"></canvas>
                </div>
            </div>
            <hr />
            <h6 class="card-title">LEIs report</h6>
            <p class="card-text">Download a report with all your LEIs</p>
            <div class="mt-4" v-if="!download.done">
                <button v-if="download.showRetry" type="button" class="btn btn-sec" @click.prevent="retry">Retry</button>
                <div v-else class="btn-group">
                    <button type="button" class="btn btn-sec" @click.prevent="downloadAsCsv"
                        :disabled="download.started">Download as Csv</button>
                    <button type="button" class="btn btn-sec dropdown-toggle dropdown-toggle-split"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" :disabled="download.started">
                        <span class="sr-only">Toggle Dropdown</span>
                    </button>
                    <div class="dropdown-menu">
                        <button type="button" class="dropdown-item" @click.prevent="downloadAsJson"
                            :disabled="download.started">Download as Json</button>
                    </div>
                </div>
                <button v-if="download.started&&!download.stopped" type="button" class="btn btn-sec ml-3" @click.prevent="stop">Stop</button>
                <div v-else-if="!download.started" class="ml-3" style="display:inline;">
                    Start at
                    <input type="number" id="madrec-leis-report-cursor" placeholder="Start at" value="0" class="form-control mr-3" style="display: inline-block; width: 7em;">
                    Step
                    <select id="madrec-leis-report-step" class="custom-select" style="width: auto;">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                    </select>
                </div>
                <span v-if="download.started" class="ml-3">{{download.msg}}</span>
            </div>
            <div class="mt-2" v-else>
                <p class="card-text"><i class="fas fa-check text-success fa-fw mr-2"></i> {{download.msg}}</p>
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" id="sec-pie-chart">
    <svg class="pie" width="84" height="84">
        <path v-for="item in items" :d="item.path" :fill="item.color" />
        <text v-for="item in items" :x="item.text.x" :y="item.text.y">{{item.text.value}}</text>
    </svg>
</script>

<script type="text/javascript">
    var MADRec = (function() {
        /*DATA LISTS*/
        var ISO_3166_1_ALPHA_2 = [
                "AD","AE","AF","AG","AI","AL","AM","AO","AQ","AR","AS","AT","AU","AW","AX","AZ","BA","BB","BD","BE","BF","BG","BH","BI","BJ","BL","BM","BN",
                "BO","BQ","BR","BS","BT","BV","BW","BY","BZ","CA","CC","CD","CF","CG","CH","CI","CK","CL","CM","CN","CO","CR","CU","CV","CW","CX","CY","CZ",
                "DE","DJ","DK","DM","DO","DZ","EC","EE","EG","EH","ER","ES","ET","FI","FJ","FK","FM","FO","FR","GA","GB","GD","GE","GF","GG","GH","GI","GL",
                "GM","GN","GP","GQ","GR","GS","GT","GU","GW","GY","HK","HM","HN","HR","HT","HU","ID","IE","IL","IM","IN","IO","IQ","IR","IS","IT","JE","JM",
                "JO","JP","KE","KG","KH","KI","KM","KN","KP","KR","KW","KY","KZ","LA","LB","LC","LI","LK","LR","LS","LT","LU","LV","LY","MA","MC","MD","ME",
                "MF","MG","MH","MK","ML","MM","MN","MO","MP","MQ","MR","MS","MT","MU","MV","MW","MX","MY","MZ","NA","NC","NE","NF","NG","NI","NL","NO","NP",
                "NR","NU","NZ","OM","PA","PE","PF","PG","PH","PK","PL","PM","PN","PR","PS","PT","PW","PY","QA","RE","RO","RS","RU","RW","SA","SB","SC","SD",
                "SE","SG","SH","SI","SJ","SK","SL","SM","SN","SO","SR","SS","ST","SV","SX","SY","SZ","TC","TD","TF","TG","TH","TJ","TK","TL","TM","TN","TO",
                "TR","TT","TV","TW","TZ","UA","UG","UM","US","UY","UZ","VA","VC","VE","VG","VI","VN","VU","WF","WS","YE","YT","ZA","ZM","ZW"],
            ISO_3166_1_ALPHA_3 = [
                "AND","ARE","AFG","ATG","AIA","ALB","ARM","AGO","ATA","ARG","ASM","AUT","AUS","ABW","ALA","AZE","BIH","BRB","BGD","BEL","BFA","BGR","BHR",
                "BDI","BEN","BLM","BMU","BRN","BOL","BES","BRA","BHS","BTN","BVT","BWA","BLR","BLZ","CAN","CCK","COD","CAF","COG","CHE","CIV","COK","CHL",
                "CMR","CHN","COL","CRI","CUB","CPV","CUW","CXR","CYP","CZE","DEU","DJI","DNK","DMA","DOM","DZA","ECU","EST","EGY","ESH","ERI","ESP","ETH",
                "FIN","FJI","FLK","FSM","FRO","FRA","GAB","GBR","GRD","GEO","GUF","GGY","GHA","GIB","GRL","GMB","GIN","GLP","GNQ","GRC","SGS","GTM","GUM",
                "GNB","GUY","HKG","HMD","HND","HRV","HTI","HUN","IDN","IRL","ISR","IMN","IND","IOT","IRQ","IRN","ISL","ITA","JEY","JAM","JOR","JPN","KEN",
                "KGZ","KHM","KIR","COM","KNA","PRK","KOR","KWT","CYM","KAZ","LAO","LBN","LCA","LIE","LKA","LBR","LSO","LTU","LUX","LVA","LBY","MAR","MCO",
                "MDA","MNE","MAF","MDG","MHL","MKD","MLI","MMR","MNG","MAC","MNP","MTQ","MRT","MSR","MLT","MUS","MDV","MWI","MEX","MYS","MOZ","NAM","NCL",
                "NER","NFK","NGA","NIC","NLD","NOR","NPL","NRU","NIU","NZL","OMN","PAN","PER","PYF","PNG","PHL","PAK","POL","SPM","PCN","PRI","PSE","PRT",
                "PLW","PRY","QAT","REU","ROU","SRB","RUS","RWA","SAU","SLB","SYC","SDN","SWE","SGP","SHN","SVN","SJM","SVK","SLE","SMR","SEN","SOM","SUR",
                "SSD","STP","SLV","SXM","SYR","SWZ","TCA","TCD","ATF","TGO","THA","TJK","TKL","TLS","TKM","TUN","TON","TUR","TTO","TUV","TWN","TZA","UKR",
                "UGA","UMI","USA","URY","UZB","VAT","VCT","VEN","VGB","VIR","VNM","VUT","WLF","WSM","YEM","MYT","ZAF","ZMB","ZWE"],
            ELF = [
                "CDOV","CRL9","CYW2","GAJN","M27U","OLAI","P65N","PCRJ","PT6C","REUP","T5RL","UV8T","V905","YCV2","6W6X","BC38","J4JC","LZFR","PQHL",
                "Q82Q","R4KK","TXVC","XHCV","1NOX","5WWO","69H1","AAL7","AXSB","CAQ1","DM88","ECWU","EQOV","G3R6","GVPD","JQOI","JTAV","JUHG","NIJH",
                "O65B","ONF1","1TX8","2QSA","36KV","3LMA","3N94","4E5P","7SJP","8E2A","8YLB","B910","C609","CFH5","EDMK","EXY8","J5OU","JNAD","KLBO",
                "KM6O","LWHF","LWV6","N5NT","O59C","O5HQ","PVT3","QZIS","R85P","T922","TPTU","U2PN","U5KF","UCT9","UW1Y","V03J","V8L7","W3WH","WTLP",
                "X8ZK","XLEO","XQZX","Y1Q4","YBHM","ZOK2","ZSFX","ZUHK","1TX8","2QSA","36KV","3LMA","3N94","4E5P","7SJP","8E2A","8YLB","B910","C609",
                "CFH5","EDMK","EXY8","J5OU","JNAD","KLBO","KM6O","LWHF","LWV6","N5NT","O59C","O5HQ","PVT3","QZIS","R85P","T922","TPTU","U2PN","U5KF",
                "UCT9","UW1Y","V03J","V8L7","W3WH","WTLP","X8ZK","XLEO","XQZX","Y1Q4","YBHM","ZOK2","ZSFX","ZUHK","1TX8","2QSA","36KV","3LMA","3N94",
                "4E5P","7SJP","8E2A","8YLB","B910","C609","CFH5","EDMK","EXY8","J5OU","JNAD","KLBO","KM6O","LWHF","LWV6","N5NT","O59C","O5HQ","PVT3",
                "QZIS","R85P","T922","TPTU","U2PN","U5KF","UCT9","UW1Y","V03J","V8L7","W3WH","WTLP","X8ZK","XLEO","XQZX","Y1Q4","YBHM","ZOK2","ZSFX",
                "ZUHK","1A0A","3Y5C","4S4Z","4ZBE","51WZ","56MU","92JZ","AS4W","B2UK","DQMJ","FCPM","IPTQ","JFQ5","KSHL","NPFB","SNRI","VHIY","X088",
                "XL51","4IXL","771I","QK1F","Y2L3","946C","CTCH","EJ06","FPP2","HN63","PW3Y","S94S","SZW0","TCGV","U8LM","VJ3G","WTK4","WVIN","1EQC",
                "60MF","BASA","BH5D","C9KZ","DK7L","G65S","J3C5","K1QX","KVC1","R0KX","RHVP","RN4K","TRO6","TS9O","U938","1CML","23V9","AW80","F9J3",
                "HLBQ","LNBY","LRRN","O13B","OTU7","QODJ","S3K4","TGLV","WFPH","XOYI","YG5M","59T2","6TRA","D90J","M4IF","MGE0","UDLA","3Q15","56KZ",
                "6U2Q","7P8Y","B3RX","D8UQ","DHGI","EKRT","EPFN","GF6X","GLX2","IKMB","JBBW","M53U","MY4W","ZACY","85EC","TA98","VAPN","876U","8M03",
                "FQJ9","T0CV","TY0S","ULJ1","Y80K","2FHC","3M14","42GN","8OZ0","9XHE","GG0S","W8XG","1JGX","456Q","7VKC","BOYK","CMB6","EIDL","ESVK",
                "FBQL","HQKE","O90R","PCO0","3OVJ","5D9I","5EEA","7IKZ","7XZL","8KL5","FYYY","I8VP","JNCJ","KZDW","L2NN","LMSY","UWMY","94UQ","B69V",
                "PXPK","VHXN","5ONY","9D1K","FN6X","G9PJ","GM04","HBCT","LV28","MXLT","OPRT","RBBY","SS1V","Y485","1E9M","3Y5V","ASWX","EBYQ","ER0H",
                "GTBR","IKGM","SYPT","1ADH","CS15","KAM9","PIDT","QN8Y","QR4F","TPZ2","W126","59T2","6TRA","D90J","M4IF","MGE0","UDLA","40JO","44LR",
                "4M62","64XG","8MEC","AXW3","FGSL","GPG0","IDBS","IKSU","ILON","NONB","QJ3A","QNSC","TSQ7","WI0P","ZY4E","10UR","2U3G","814Y","A7KA",
                "CT3J","JVMD","QB2W","RQIC","T1LR","TWLR","UG3Z","YRUJ","Z6MF","24EG","2FED","3OW3","8VRU","9D9U","E9CM","EYKU","G5RH","IVVD","KP34",
                "LUMA","MF7P","NRTG","OQWO","YA9S","ZFQS","1SVL","1T06","2J66","36AO","5OZV","9E0Q","ADF8","IHD0","KM1T","MZB1","SS3A","WV3I","ZKTC",
                "1MBR","233U","8BL9","BCF5","FV0K","GLCH","HIL6","I8RE","INTY","K9L6","MYKG","P12B","RCPI","T1JS","U24X","W86L","1JK6","2DK3","2N9X",
                "3BX3","3G3D","3RMA","4A26","4OTK","4UB2","4YAK","5AP3","5KU5","6CQN","6FAI","6OMW","747U","74W6","7OZQ","84J8","8K5T","917C","95G8",
                "971Y","9HLU","9RVC","9XDB","AM3T","APEN","BL4B","C4Q2","C5FE","C7GZ","CATU","CD28","CHJR","CIO8","CUKQ","CZUA","D1VK","D35X","ET6Z",
                "FIPS","FY1B","G2I3","H4XQ","H6WW","HQPK","HS5W","HSNC","HY6K","I32F","I68R","IQ9O","J8PB","JCAD","JJYB","KM6Z","LEDI","LJ92","LJL0",
                "LPCQ","MAVU","MBUU","NI3I","NJ87","NPH3","NQHQ","O9PW","OVKW","P3YF","PFE5","PQJE","Q25I","QIEL","QJ0F","QJWK","QQ49","QS6A","R2XE",
                "RBGQ","RHFQ","RP0E","T1FT","T3Q1","TNBA","U95A","UFDA","V6YH","VIE3","VQU7","WJ30","WL83","WO0T","WUFK","WVZF","XG70","XRK7","Y18E",
                "Z3BF","ZQO8","ZU32","5QS7","7WRN","9KSX","FUKI","FW7S","GULL","H8VP","LWOD","NUL8","PZ6Y","TB2C","UA1O","WU7R","ZRPO","1NKP","3UPJ",
                "6I0P","752Q","8ZQE","9LJA","CKOS","GA3A","I1UP","J34T","JC0Y","LA47","LVEQ","PMOF","PRTB","RXTT","VSEV","157O","1B88","1GNM","1L24",
                "1NF1","1Q16","1Y0C","211B","29FA","2N4L","2NL6","2ONM","2WMP","2XIK","34QS","3AZY","3FCU","3NJL","3OK3","3S6E","3XTE","487E","491H",
                "4DZU","4H0F","4JS0","4RT7","4TNX","4VD7","59F9","5AJO","5H68","5K0Q","5VCF","61WE","66JQ","6CHY","6CJJ","6DYI","6IIE","6KWU","6RUE",
                "6SYJ","6YHU","74HH","7O94","7SZH","7UHA","82QO","87VO","8FZW","8G07","8GTU","8II5","8IWA","8LX5","8OKM","8R2G","8TYA","8VDW","8VWR",
                "8WH8","8XDK","94WO","97PZ","9HC8","9KU7","9N1F","9O0S","9T5S","A0VZ","AHBR","AMFI","B645","B7I7","BAK2","BAUQ","BDDP","BEWI","BRGA",
                "BYZF","C42J","C4D7","CAX5","CBO2","CF56","CNSS","CNXL","CQJI","CVH6","D2I2","DEG4","DRQM","DTAX","DWYD","DXQH","E0YF","E6YB","EABD",
                "EAC8","ECUL","EVYY","EYRI","F0B6","F6SZ","F72Z","F8UD","F93F","FBYB","FEEA","FFQL","FKG2","FOUY","FY0F","FYBN","G7Z2","G8LP","G98S",
                "GFN6","GLN8","GQV4","GXL6","GZCQ","H1U2","H3Z4","H3ZD","H4VR","HA3N","HATI","HC8N","HF2L","HMEI","HSYZ","I0MH","I8TE","IAP3","IC8G",
                "IC98","IF7H","IGSV","IQR2","J9OZ","JBIQ","JFET","JIYK","JM1W","JMO0","JN2P","JR7T","JU82","K39X","K5KA","K65D","K69X","K7XQ","K99N",
                "KBEQ","KCN5","KFR1","KMPN","KQH7","KS9B","KWI4","L25Z","L6QO","LARO","LGME","LU8S","LUIN","M1BJ","M673","MG2O","MMA4","MOUL","MQPZ",
                "MX8J","NBA8","NFCV","NM07","NOI8","NQCT","NUMY","OAGA","OIQA","OLJ1","OSLZ","OWUN","P3J5","P714","PESN","PL6V","PWKL","PZLG","Q2A1",
                "Q634","Q8E2","QCWO","QU3G","QUB4","QV2O","R0B6","R1JO","R59A","R6WQ","RD0Z","RFWH","RNJZ","RNSB","RT39","RT6Y","RWMC","S0X8","S82R",
                "SMZ6","SSHN","SWPX","SZ63","T25Y","TGRE","TNPO","TOL2","TPNT","TUE5","UFM7","UHKH","UQRY","UUT8","UV02","UZY3","V1Z5","V5SV","V6G1",
                "V9QP","VBC7","VBQP","VD7Z","VJV5","VO18","VTFS","W3LD","W4G1","WGCY","WXNU","X78I","XH8C","XK4T","XPX6","XQBA","Y1W1","Y4VA","Y7G8",
                "Y8WC","YADL","YHI5","YJM5","YUCL","YX4E","Z0JP","Z2FQ","Z5WG","Z9K8","ZECH","ZM5P","ZPEZ","ZQ9B","ZQIT","ZXHJ","ZZ0X","13AV","2HBR",
                "2YZO","40DB","63KS","6QQB","8CM0","8Z6G","JNDX","OL20","QZ3L","SGST","SUA1","T0YJ","US8E","4HD1","56NA","I0X7","J5RC","PH5T","T69Z",
                "VBJW","W9ZD","WP5I","XWPT","7U4R","CB98","GCCT","M4TI","QFLH","TKPE","UUYB","VJRL","WBKH","Y8CL","3RHO","54AL","CQ5X","H6OR","HKVP",
                "J3VJ","JYKN","L6IY","L8D6","MCWR","QCA0","QSYQ","TIZ2","UCU5","VKSR","W2NK","9XFK","BVOE","Q49K","UO3D","254M","85VD","E1SE","EPG7",
                "KSUS","N3VO","S2E3","UDG6","XPE5","254M","85VD","E1SE","EPG7","KSUS","N3VO","S2E3","UDG6","XPE5","4WV7","876R","8UEG","8VH3","995K",
                "BKUX","BMYJ","DN6F","DPY1","EO9F","HTJD","J6MO","M1DW","NZAI","P9F2","S3DA","TQ3O","TSVO","UD8K","X0SX","XW5U","Y64R","2OJP","8T79",
                "CMHQ","E4KB","M8SS","2GV9","363J","54SK","5AX8","9BPE","C58S","DWS3","FF1D","HNJK","JXDX","KMFX","LGWG","LMIM","LZIC","MNQ7","URQH",
                "ZJS8","VYAX","5AX8","C58S","FF1D","KMFX","LGWG","LMIM","LZIC","MNQ7","URQH","VYAX","1G26","5ABK","CDXK","EMLA","FI4M","FMPL","G4V6",
                "JHC4","M44Y","OESH","QZTT","SAI8","SP9F","TE79","TQ3Z","TV5P","VC3E","ZGPY","135L","2SZI","2XXH","5ODO","634M","70X0","8GU1","9KGS",
                "BL52","DCRK","DSSD","HN75","K021","KCHO","KCSG","LHBB","LZZD","NDEW","OV32","P418","QRZJ","T2X1","VA1V","VDRB","VUPE","W9SC","X62Z",
                "ZG6S","ZZOG","21F4","33IP","40A7","7RZH","JOX1","LO9A","SQXV","UBWU","1IPK","3LCY","AZTM","BS22","ES2D","VJBO","1DGT","1SOY","32HC",
                "7RRP","ANSR","BSZ8","IF49","K98U","NDID","TMU1","WAK8","Y8LH","13T9","4ZF3","5BY2","5CIE","5TA8","6JDN","81KA","A2GC","A338","BGPJ",
                "BPLS","DLCX","E4HU","F2TQ","F2ZF","HGMH","HJ1Y","K4GR","KWBA","LUGM","LUOA","NVPY","Q4A3","Q8UI","QG9Y","QRXD","SFK9","SFYA","UHNL",
                "WQRG","X8J8","YRXK","2IGL","2JEI","2S2U","5DWL","5GGB","63P9","68J6","81G5","9C91","ATQY","BEAN","BKAB","DVXS","JIWD","LCR0","SQ1A",
                "U8KA","UDY2","V19Y","V5OS","WCEP","ZFFA","BVJ0","C061","CR7N","JOZN","V89C","YB0U","BVJ0","C061","CR7N","JOZN","V89C","4AJY","6M6Z",
                "AOS4","B0LD","BVPF","G7H0","J76S","JWWT","RJYT","RTVE","S2J1","XXCZ","ZTUI","O786","33MN","4QXM","54M6","5WU6","62Y3","9AAK","A0W7",
                "B5PM","BBEB","CODH","DEO1","EZQW","GNXT","JHK5","L7HX","NFFH","UNJ2","V44D","Y3ZB","4LEA","F7KI","P2R9","Z6ZU","326Y","3C7U","3L58",
                "4ZRR","50TD","5ZTZ","8S9H","9DI1","AEV1","BJ65","CF5L","DRPL","EXD7","FSBD","GYY6","IQGE","K5P8","LJJW","M9IQ","O0EU","O7LB","PB3V",
                "Q0Q1","R71C","V06W","YI42","YTMC","ZQ0Q","4XMS","7IYW","88OX","QR25","RKYF","VQV6","XBK3","LH0Q","MOI8","13ZV","3BJG","5F76","60BG",
                "629I","6LUM","6OYI","8TOF","96XK","AL9T","BSJT","CY1M","EU0T","F21U","FANM","FJ0E","FQ5Y","GZE5","H7OD","HOT8","J3A3","JCKO","KM66",
                "LT9U","O7XB","OMX0","P1L1","QUX1","QYL4","RBHP","RUCO","SMIS","SP4S","SVA3","T7PB","WNX1","WOK7","WUJ2","YLZL","ZVVM","ZZKE","IKBN",
                "Z7ZX","1HGD","5KVH","68PD","6IK8","6L6P","99JD","A8CT","ALPT","D7OA","DFE5","IX01","KUUV","MFHR","N66B","NIQY","OXUC","P5S3","PIDC",
                "QFXD","USOG","VF4C","W9W3","XD16","XMXM","YMLD","Z0NE","ZILA","ZSWE","149O","DTIU","HEXO","JCK1","KHAB","KXDY","VPFY","XH7Z","1CDX",
                "37II","4V0A","5NCK","7B9H","7W9B","85K5","8FD2","AI01","ANDT","CTBD","CUGP","DUGD","EFBR","F0BK","F68H","FJQ8","GT4V","I15K","I9BB",
                "NFRJ","SWMK","TH8A","UWEE","V0FL","XHN1","15A2","17R7","1MJ0","1RJ2","1U7Y","24TU","2H36","2OTW","2R46","37YG","3AMJ","3EAX","3F98",
                "3TOV","3U8X","4PZX","4TYO","4VTZ","5VMR","6H83","8B9A","8JWV","8MQM","8NF7","8NZE","8RIH","8XDD","9RQZ","AS78","B5GH","BLVV","BQ3A",
                "BZQL","C3RQ","C7TI","CKTA","CN7I","D094","D84J","DO25","DZSY","E0VI","EH3M","EWQF","FWGK","FZKX","G2CW","GHC5","GQRJ","GWHK","GZF9",
                "H2AF","H2P4","H4NY","HKKL","HUET","HUR1","I9O1","I9V2","IBSS","IC46","ILY0","J18N","J7NW","JPMQ","JZBN","KLA2","KOYR","KVSH","KZC6",
                "LLL8","LYTH","MG22","MV1C","MVSF","NRK9","NZ85","O1KO","OCIS","OPLQ","OVLN","P9CF","PA5X","PDYW","PJRZ","Q9FA","QCRH","QFGM","QKFU",
                "QMEH","QQS1","QSXT","QUMQ","R71T","RJUK","SDVV","SIPP","TLDB","TMIG","UTBN","UY49","VA0A","VAB6","VE1P","VEOU","VEX5","VIGZ","VOUU",
                "WJXS","WYNO","XBRI","XIGI","XINV","XJJR","XNKN","YA7H","YGHZ","YJ6A","Z2AQ","Z3SH","Z3Y0","ZGYA","ZH3O","ZKAF","ZNHF","1RPE","7WL9",
                "BCM3","M6YY","QWFD","SXY3","TOMA","6UPM","73PZ","88TX","9O67","DEF6","E7W8","KIU5","YVPW","ZPOY","17FJ","2PHU","5SGV","KEMH","LWXI",
                "14NU","189Q","1CSW","1GLU","1HEP","1K73","1W8B","2EEG","2KMA","2XNE","3P3W","43MZ","46CD","4CKX","4GX1","5AM3","5J5Y","5YBL","5Z8W",
                "6R72","72R7","73MQ","7EG2","7O89","7QSE","8KHD","8RE3","8UE6","90YN","93WZ","95MS","9L9V","9NSV","AGSR","BKEB","BUMI","C4PZ","CS8B",
                "D18J","DAQC","E1VK","E4CI","E9SH","ED84","ER02","F560","FDVU","FMUC","FQRE","GL07","GY5R","HZG7","HZI2","I7AS","ISCZ","IW8Z","J8DW",
                "JKC5","KB52","KVQU","KWFE","KZ3R","L1M7","L9WT","MSGT","MY1S","N5MX","N7I1","N9QW","NC88","NL31","NLI7","NO20","O0Y2","O7TC","OKAZ",
                "P6XJ","PX29","QACV","QCJ9","R9GT","RF3D","S5E1","SIRY","SMUS","SPIE","SQ4I","SQFW","STUP","SUH3","T0KQ","TAV3","TG3X","U3QQ","U5IM",
                "U7QK","UCTO","VATN","VRJP","VSC1","VSZS","WQCR","XLXU","Y1X5","Y45Q","YB59","YF99","YGN4","YRIU","YVE8","YVWB","ZG2I","1OR3","4A8T",
                "KBKD","OPDJ","SD81","WZ78","4YUU","CXWJ","GQVQ","J7L0","MZT6","R155","R59V","U89P","XE4Z","ZE81","1G29","1QU8","1SL4","1ZHJ","4S57",
                "5RDO","7U8O","956I","9FPZ","A97B","AJ9U","ARDP","AXS5","B0V5","BI3B","CUIH","DDES","DP3Q","FCJF","FH4R","GJL1","GJTL","HRQA","I2WU",
                "IAS6","IT6N","JB2M","JTV5","K0RI","K6L9","QMUM","R2L8","S0Z5","S6X7","SS0L","TDD5","UJ35","VFIU","XYGP","1TN0","2UAX","381R","54P7",
                "9YIP","AZTO","BEAY","BYQJ","C61P","CX05","G04R","M0Y0","O1QI","OJ9I","PDQ0","RLJO","RYFP","SSOM","WZDB","XJHM","1BL5","1RKS","2B81",
                "2JZ4","2WFG","2XJA","3EKS","54WI","5BEZ","7MNN","AZA0","BF9N","CQMY","DP2E","E0NE","FFTN","GP8M","H781","HX77","JB25","KJ9Q","L5DU",
                "M848","MRSY","MVII","OBFU","QSI2","R9TC","TL87","UNA9","VPRH","W6A7","XJOT","YRGM","1BL5","1RKS","2B81","2JZ4","2WFG","2XJA","3EKS",
                "54WI","5BEZ","7MNN","AZA0","BF9N","CQMY","DP2E","E0NE","FFTN","GP8M","H781","HX77","JB25","KJ9Q","L5DU","M848","MRSY","MVII","OBFU",
                "QSI2","R9TC","TL87","UNA9","VPRH","W6A7","XJOT","YRGM","1BL5","1RKS","2B81","2JZ4","2WFG","2XJA","3EKS","54WI","5BEZ","7MNN","AZA0",
                "BF9N","CQMY","DP2E","E0NE","FFTN","GP8M","H781","HX77","JB25","KJ9Q","L5DU","M848","MRSY","MVII","OBFU","QSI2","R9TC","TL87","UNA9",
                "VPRH","W6A7","XJOT","YRGM","1BL5","1RKS","2B81","2JZ4","2WFG","2XJA","3EKS","54WI","5BEZ","7MNN","AZA0","BF9N","CQMY","DP2E","E0NE",
                "FFTN","GP8M","H781","HX77","JB25","KJ9Q","L5DU","M848","MRSY","MVII","OBFU","QSI2","R9TC","TL87","UNA9","VPRH","W6A7","XJOT","YRGM",
                "JMQU","ONVA","R5UT","W2SQ","55MA","T61R","WJ0A","4GJI","57V7","B6ES","CDOT","H0PO","ID30","Q0M5","U6R9","Z0EY","ZQ6S","HHYT","5MNR",
                "78H5","A9AW","D8PB","FGVH","IMDT","IVQQ","N69M","O85W","P24O","QEEJ","QUJ5","RSWJ","S68T","ST2Q","UGE3","VKPN","1ASH","1ONH","37F5",
                "43LY","6ZAR","8OK2","9HKD","9I4Y","BQRL","DEMP","IYZI","LDBS","OXAZ","S2K8","T4OL","TBN1","UJ49","1QMT","358I","3DXJ","4LKE","5JAL",
                "6NI8","8QMN","ARON","CJ58","F99D","IHLF","JF6D","Q4F9","Q6EM","SIST","U94O","UFIY","UKX4","X0MP","X1EL","Y5L0","YJZ3","WY1B","52U0",
                "7VK5","95OK","AEJF","BTQ1","EZNQ","FZMT","ZD39","74LJ","CNQ3","IPGV","O35K","SQOE","TJ6V","VNIU","ZJPG"],
            EMIR = ["FC","NFC-","NFC+"];

        /*DATA REGEX*/
        var LEI = /^[0-9A-Z]{4}[0-9A-Z]{14}\d{2}$/,
            NACE_CLASS = /^\d{2}\.\d{2}$/,
            NACE_GROUP = /^\d{2}\.\d$/,
            NACE_DIVISION = /^\d{2}$/,
            BIC = /^[0-9A-Z]{4}([A-Z]{2})[0-9A-Z]{2}([0-9A-Z]{3})?$/,
            YN = /^(true|false|y|n)$/i,
            GK = /^(\d{6}|[1-9]\d{0,5})$/,
            PERMID = /^\d{10}$/,
            LEGAL_FORM = /^[0-9A-Z]{4}$/;

        /*UTILS*/
        function ISO_7064_MOD_97_10(x) {
            let p = 0;
            for (let i = 0; i < x.length; i++) {
                let c = x.charCodeAt(i);
                p = c + (c >= 65 ? p * 100 - 55 : p * 10 - 48); /* 'A' is 65, '0' is 48 */
                if (p > 10000) p %= 97;
            }
            return p % 97;
        }

        /*VERIFIERS/TRANSFORMERS*/
        var verifiers = {
            "LEI": x => { /*ISO 17442*/
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                x = x.toUpperCase();
                let m = x.match(LEI);
                if (m == null)
                    return { success: false, error: "format is incorrect (not ISO-17442)" };
                if (ISO_7064_MOD_97_10(m[0]) != 1)
                    return { success: false, error: "incorrect check sum" };
                return { success: true, value: x };
            },
            "BIC": x => { /*ISO 9362:2014*/
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                x = x.toUpperCase();
                let m = x.match(BIC);
                if (m == null)
                    return { success: false, error: "format is incorrect" };
                if (!ISO_3166_1_ALPHA_2.includes(m[1]))
                    return { success: false, error: "'" + m[1] + "' is not a valid country (ISO 3166-1 Alpha 2)" };
                if(x.length == 8)
                    return { success: true, value: x + "XXX", warning: "should be 11 characters, 'XXX' appended" };
                return { success: true, value: x };
            },
            "EMIR": x => {
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                x = x.toUpperCase();
                if(x.length != 2 && x.length != 4)
                    return { success: false, error: "format is incorrect" };
                if(!EMIR.includes(x))
                    return { success: false, error: "is not in the list" };
                return { success: true, value: x };
            },
            "YN": x => {
                if(typeof x === "boolean")
                    return { success: true, value: x ? "Y" : "N", warning: "boolean transformed to " + (x ? "'Y'" : "'N'") };
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                let m = x.match(YN);
                if (m == null)
                    return { success: false, error: "format is incorrect" };
                if(x == "Y" || x == "N")
                    return { success: true };
                let y = x.toUpperCase(), z = y == "TRUE" || y == "Y" ? "Y" : "N";
                return { success: true, value: z, warning: "'" + x + "' transformed to '" + z + "'" };
            },
            "GK": x => {
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                let m = x.match(GK);
                if (m == null)
                    return { success: false, error: "format is incorrect" };
                if(x.length != 6)
                    return { success: true, value: "0".repeat(6 - x.length) + x, warning: "should be 6 numbers, leading zeros added" };
                return { success: true };
            },
            "PERMID": x => {
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                let m = x.match(PERMID);
                if (m == null)
                    return { success: false, error: "format is incorrect" };
                return { success: true };
            },
            "NACE_CLASS": x => {
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                let m = x.match(NACE_CLASS);
                if (m == null)
                    return { success: false, error: "format is incorrect" };
                return { success: true };
            },
            "NACE_GRP": x => {
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                let m = x.match(NACE_GROUP);
                if (m == null)
                    return { success: false, error: "format is incorrect" };
                return { success: true };
            },
            "NACE_DIV": x => {
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                let m = x.match(NACE_DIVISION);
                if (m == null)
                    return { success: false, error: "format is incorrect" };
                return { success: true };
            },
            "CLEAN_STR": x => {
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                x = x.trim().replace(/\s+/gi, " ").replace(/[^\w\d\s]/gi, "").toUpperCase();
                return { success: true, value: x };
            },
            "LEGAL_FORM": x => {
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                let m = x.match(LEGAL_FORM);
                if (m == null)
                    return { success: false, error: "format is incorrect" };
                if(!ELF.includes(x))
                    return { success: false, error: "is not in the list" };
                return { success: true };
            },
            "COUNTRY": x => { /*ISO 3166-1-ALPHA-3*/
                if(typeof x !== "string")
                    return { success: false, error: "expecting a string" };
                x = x.toUpperCase();
                if(x.length != 3)
                    return { success: false, error: "format is incorrect" };
                if(!ISO_3166_1_ALPHA_3.includes(x))
                    return { success: false, error: "'" + x + "' is not a valid country (ISO 3166-1 Alpha 3)" };
                return { success: true, value: x };
            }
        };

        return {
            lei: { name: "LEI Code", type: "text", verifier: verifiers.LEI, sample: "254900DIU0FZCNP9N347" },
            fields: [
                { name: "BIC Code", type: "text", verifier: verifiers.BIC, sample: "0000GB00XXX" },
                { name: "EMIR Classification", type: "list", values: EMIR, verifier: verifiers.EMIR, sample: "FC" },
                { name: "Investment Firm", type: "bool", verifier: verifiers.YN, sample: "Y" },
                { name: "GK Code", type: "text", verifier: verifiers.GK, sample: "123456" },
                { name: "PermID Code", type: "text", verifier: verifiers.PERMID, sample: "0123456789" },
                { name: "NACE Class", type: "text", verifier: verifiers.NACE_CLASS, sample: "11.11" },
                { name: "NACE Group", type: "text", verifier: verifiers.NACE_GRP, sample: "11.1" },
                { name: "NACE Division", type: "text", verifier: verifiers.NACE_DIV, sample: "11" },
                { name: "Immediate Parent", type: "text", verifier: verifiers.LEI, sample: "254900DIU0FZCNP9N347" },
                { name: "Ultimate Parent", type: "text", verifier: verifiers.LEI, sample: "254900DIU0FZCNP9N347" },
                { name: "Full Legal Name", type: "text", verifier: verifiers.CLEAN_STR, sample: "Full Legal Name" },
                { name: "Legal Form", type: "list", values: ELF, verifier: verifiers.LEGAL_FORM, sample: "CDOV" },
                { name: "Country of Operation", type: "list", values: ISO_3166_1_ALPHA_3, verifier: verifiers.COUNTRY, sample: "AND" },
                { name: "Country of Incorporation", type: "list", values: ISO_3166_1_ALPHA_3, verifier: verifiers.COUNTRY, sample: "ARE" },
                { name: "Country of Asset Location", type: "list", values: ISO_3166_1_ALPHA_3, verifier: verifiers.COUNTRY, sample: "AFG" },
                { name: "US Person", type: "bool", verifier: verifiers.YN, sample: "N" },
                { name: "Company Registration Number", type: "text", verifier: verifiers.CLEAN_STR, sample: "123456789A" }
            ]
        };
    })();

    const MADRecUtils = {
        fieldsIndex: Object.assign({}, ...MADRec.fields.map((f, i) => ({[f.name]: i}))),
        fillReport(fields) {
            for(var name in fields) {
                let field = fields[name];
                if(field.total == 1) {
                    field.report = "no match";
                }
                else if(field.split.length == 1) {
                    field.report = "full consensus";
                }
                else if(field.split.length < field.total) {
                    field.report = "split consensus with " + (field.group == 0 ? "majority" : "minority");
                }
                else {
                    field.report = "no consensus";
                }
            }
        },
        fillColors(fields) {
            for(var name in fields) {
                let field = fields[name];
                if(field.total == 1) {
                    field.colors = ["#28a745"];
                }
                else if(field.split.length == 1) {
                    field.colors = field.total == 2 ? ["#28a745"] : ["#218838"];
                }
                else if(field.split.length < field.total) {
                    field.colors = field.split[1].count == 1 ? ["#28a745"] : ["#ffc107"];
                    for (var j = 1; j < field.split.length; j++) field.colors.push("#fd7e14");
                }
                else {
                    field.colors = ["#fd7e14"];
                    for (var j = 1; j < field.split.length; j++) field.colors.push("#ffe8a1");
                }
                field.groups = field.split.map(x => x.count);
                field.color = field.colors[field.group];
            }
        },
        verifyFieldNames(data) {
            for (var f in data) {
                if(f != MADRec.lei.name && f != "Original " + MADRec.lei.name && fieldsIndex[f.name] != undefined)
                    return { success: false, field: f };
            }
            return { success: true };
        },
        verifyData(lei, data) {
            let warnings = {}, isHashed = false;
            if(typeof lei === "string" && lei.length == 44) { // hashed value, can't verify
                warnings["You are using pre-hashed values, can't verify format"] = 1;
                isHashed = true;
            } else {
                let v = MADRec.lei.verifier(lei);
                if(v.success !== true) {
                    v.field = MADRec.lei.name;
                    v.value = lei;
                    return v;
                }
            }
            for(let f of MADRec.fields) {
                if(data[f.name] !== "" && data[f.name] != null) {
                    if(isHashed) {
                        if(typeof data[f.name] !== "string" || data[f.name].length != 44) {
                            return { success: false, warnings: warnings,
                                error: "Inconsistent hashing for field '" + f.name + "'. Expecting a hashed value" };
                        }
                    } else {
                        let v = f.verifier(data[f.name]);
                        if(v.success !== true) {
                            v.field = f.name;
                            v.value = data[f.name];
                            return v;
                        }
                        if(v.value !== undefined)
                            data[f.name] = v.value;
                        if(v.warning) {
                            v.warning = "'" + f.name + "' " + v.warning;
                            warnings[v.warning] = (warnings[v.warning] || 0) + 1;
                        }
                    }
                }
            };
            return { success: true, warnings: warnings, isHashed: isHashed };
        },
        toValues(a, names, i, data) {
            if(i + 1 == names.length) {
                a.push({ name: names[i], value: data });
            } else {
                let b = { name: names[i], values: [] };
                a.push(b);
                this.toValues(b.values, names, i + 1, data);
            }
        },
        async hashData(salt, data) {
            if(typeof data === 'boolean') // transform bools and double to avoid cross platform/language issues
                data = data ? "true" : "false";
            else if(typeof data === 'number')
                data = data.toFixed(6); // 6 digits to match c++ std::to_string() precision
            return await sec.utils.hashBase64(salt + data);
        },
        async rowToJson(data, hashOpt) {
            if(data[MADRec.lei.name] === undefined) return false;
            let json = { values: [] }, salt;
            if(hashOpt > 1) json.hashed = true;
            if(hashOpt == 2) salt = await sec.utils.hashBase64(data[MADRec.lei.name]);
            for (var f in data) {
                if(f == "Orignal " + MADRec.lei.name) continue;
                if(data[f] === "" || data[f] == null || data[f] == undefined) continue;
                if(hashOpt == 2) data[f] = await this.hashData(salt, data[f]);
                if(f == MADRec.lei.name) json[f] = data[f];
                else this.toValues(json.values, f.split('/'), 0, data[f]);
            }
            return json;
        }
    };

    const MADRecNetwork = store.dcapps["madrec"].network;

    Vue.set(store.user.dcapps, "madrec", {});
    Vue.set(store.user.dcapps.madrec, "data", { accessStatus: "denied", grants: 0 });
    const MADRecApp = Vue.component('sec-madrec', {
        template: '#sec-madrec',
        data: function () {
            return {
                nsRequest: new notifState(2)
            }
        },
        beforeMount: function() {
            store.SCPs[MADRecNetwork]
                .sendQuery("madrec", "get-status", "madrec-get-status")
                .onResult(x => {
                    Vue.set(store.user.dcapps.madrec.data, "accessStatus", x.status);
                    Vue.set(store.user.dcapps.madrec.data, "grants", x.grants || 0);
                });
        },
        computed: {
            records() {
                var user = store.user.dcapps.identity.data, pr = user && user.personalRecords,
                    phone = pr && pr.phone, email = pr && pr.email,
                    hasFirstname = user && user.firstname && user.firstname.length > 0,
                    hasLastname = user && user.lastname && user.lastname.length > 0,
                    hasPhoneVerified = phone && phone.value && phone.verified,
                    hasEmailVerified = email && email.value && email.verified;
                return {
                    hasEnough: hasFirstname && hasLastname && (hasPhoneVerified || hasEmailVerified),
                    hasFirstname: hasFirstname,
                    hasLastname: hasLastname,
                    hasPhoneVerified: hasPhoneVerified,
                    hasEmailVerified: hasEmailVerified
                }
            },
            requestingMembers() {
                return store.user.dcapps.madrec.data.requestingMembers || 0;
            }
        },
        methods: {
            async requestAccess() {
                let args = { id: store.dcapps.madrec.id, items: [ "firstname", "lastname" ] },
                    dcapp = store.dcapps["madrec"];
                if($("#madrec_ra_phone").is(":checked")) args.items.push("phone");
                if($("#madrec_ra_email").is(":checked")) args.items.push("email");
                this.nsRequest.start();
                store.SCPs[MADRecNetwork]
                    .sendTx("identity", "share-with", "identity-share-with", args)
                    .onError(x => { this.nsRequest.failed(x, true); })
                    .onAcknowledged(x => { this.nsRequest.acknowledged(); })
                    .onProposed(x => { this.nsRequest.proposed(); })
                    .onCommitted(x => { this.nsRequest.committed(); })
                    .onExecuted(x => {
                        this.nsRequest.executed();
                        store.SCPs[MADRecNetwork]
                            .sendTx("madrec", "request-access", "madrec-request-access", { role: "participant" })
                            .onError(x => { this.nsRequest.failed(x, true); })
                            .onAcknowledged(x => { this.nsRequest.acknowledged(); })
                            .onProposed(x => { this.nsRequest.proposed(); })
                            .onCommitted(x => { this.nsRequest.committed(); })
                            .onExecuted(x => { this.nsRequest.executed().hide(); });
                    });
            }
        }
    });
    const MADRecAppMembers = Vue.component('sec-madrec-members', {
        template: '#sec-madrec-members',
        data: function () {
            return {
                ns: new notifState(),
                members: []
            }
        },
        beforeMount: function() {
            this.getMembers();
        },
        methods: {
            getMembers() {
                this.ns.start("Updating members list", true);
                store.SCPs[MADRecNetwork]
                    .sendQuery("madrec", "get-members", "madrec-get-members")
                    .onError(x => { this.ns.failed(x, true); })
                    .onResult(x => {
                        this.ns.executed().hide(1);
                        let rp = 0;
                        this.members = x.map(p => {
                            let o = {
                                firstname: p.identity.firstname, lastname: p.identity.lastname, cooptionId: p.cooptionId,
                                status: p.status, isSelf: p.isSelf, grants: p.grants || 0, vote: p.vote || ""
                            };
                            if(p.identity.personalRecords.phone) {
                                o.phone = p.identity.personalRecords.phone.value;
                                o.phoneVerified = p.identity.personalRecords.phone.verified;
                            }
                            if(p.identity.personalRecords.email) {
                                o.email = p.identity.personalRecords.email.value;
                                o.emailVerified = p.identity.personalRecords.email.verified;
                            }
                            if(p.status == "requested") rp++;
                            return o;
                        });
                        Vue.set(store.user.dcapps.madrec.data, "requestingMembers", rp);
                    });
            },
            vote(status, cooptionId) {
                let args = { status: status, cooptionId: cooptionId };
                this.ns.start("Registering your vote", true);
                store.SCPs[MADRecNetwork]
                    .sendTx("madrec", "coopt", "madrec-coopt", args)
                    .onError(x => { this.ns.failed(x, true); })
                    .onAcknowledged(x => { this.ns.acknowledged(); })
                    .onProposed(x => { this.ns.proposed(); })
                    .onCommitted(x => { this.ns.committed(); })
                    .onExecuted(x => {
                        this.ns.executed();
                        this.getMembers();
                    });
            }
        }
    });
    const MADRecAppSingleLEI = Vue.component('sec-madrec-single-lei', {
        template: '#sec-madrec-single-lei',
        data: function () {
            return {
                nsPut: new notifState(),
                nsGet: new notifState(),
                results: [],
                exportableResults: "",
                warnings: [],
                lei: MADRec.lei,
                fields: MADRec.fields,
                useSample: true
            }
        },
        computed: {
            resultsExportUrl() {
                let blob = new Blob([this.exportableResults], { type: 'application/json;charset=utf-8;' });
                return URL.createObjectURL(blob);
            }
        },
        methods: {
            async madrecPut() {
                this.warnings = [];
                let lei = $('#madrecSingleLei').val(), values = {};
                for(let [i, f] of MADRec.fields.entries()) {
                    let v = $('#madrecSingle-' + i).val();
                    switch(f.type) {
                        case "text": if(v != "") values[f.name] = v; break;
                        case "list": if(v > -1) values[f.name] = f.values[v]; break;
                        case "bool": if(v > -1) values[f.name] = ["Y", "N"][v]; break;
                    }
                }
                let check = MADRecUtils.verifyData(lei, values), w = check.warnings;
                if(check.success !== true) {
                    this.nsPut.failed(check.field + " " + check.error, true);
                    return;
                }
                if(check.isHashed) {
                    this.nsPut.failed("Some of your data seem to be already hashed", true);
                    return;
                }
                if(w) this.warnings = Object.keys(w).map(x => { return x + (w[x] > 1 ? " (" + w[x] + "  times)" : ""); });

                let hashOpt = $('#madrecSingleHashOpt').val();
                let args = { [MADRec.lei.name]: lei, hashed: hashOpt > 1, values: [] };
                for(let v in values) {
                    args.values.push({ name: v, value: values[v]});
                }
                if(hashOpt == 2) {
                    let salt = await sec.utils.hashBase64(args[MADRec.lei.name]);
                    args[MADRec.lei.name] = await MADRecUtils.hashData(salt, args[MADRec.lei.name]);
                    for(let v of args.values) {
                        v.value = await MADRecUtils.hashData(salt, v.value);
                    }
                }

                this.nsPut.start();
                store.SCPs[MADRecNetwork]
                    .sendTx("madrec", "put", "madrec-single-put", args)
                    .onError(x => { this.nsPut.failed(x, true); })
                    .onAcknowledged(x => { this.nsPut.acknowledged(); })
                    .onProposed(x => { this.nsPut.proposed(); })
                    .onCommitted(x => { this.nsPut.committed(); })
                    .onExecuted(x => {
                        this.nsPut.executed().hide();
                        this.madrecGet();
                    });
            },
            madrecGet() {
                let lei = $("#madrecSingleLei").val(), warning = "";
                if(typeof lei === "string" && lei.length == 44)
                    warning = "hashed LEI, can't verify format";
                else {
                    let v = MADRec.lei.verifier(lei);
                    if(v.success !== true) {
                        this.nsGet.failed(v.error, true);
                        this.results = {};
                        this.exportableResults = "";
                        return;
                    }
                }
                this.nsGet.start(warning, warning != "");
                store.SCPs[MADRecNetwork]
                    .sendQuery("madrec", "get", "madrec-single-get", { [MADRec.lei.name]: lei, subscribe: true })
                    .onError(x => { this.nsGet.failed(x, true); })
                    .onResult(x => {
                        this.nsGet.executed().hide();
                        MADRecUtils.fillReport(x.fields);
                        this.exportableResults = JSON.stringify(x.fields, null, 4);
                        MADRecUtils.fillColors(x.fields);
                        this.results = x.fields;
                    });
            }
        }
    });
    const MADRecAppMultiLEI = Vue.component('sec-madrec-multi-lei', {
        template: '#sec-madrec-multi-lei',
        mounted() {
            setOnDrop(this.onDrop);
        },
        beforeDestroy() {
            setOnDrop(null);
        },
        data: function () {
            return {
                hasFile: false,
                file: null,
                fileMsg: "",
                rowsCount: 0,
                verify: {
                    blockSize: 250, done: false, msg: "", read: 0, verified: 0, warnings: [], isHashed: undefined
                },
                progressColors: {
                    sent: "bg-secondary", acknowledged: "bg-primary",
                    executed: "bg-success", failed: "bg-danger" },
                upload: {
                    blockSize: 100, done: false, msg: "", showProgress: false, blocks: [],
                    read: 0, acknowledged: 0, executed: 0, failed: 0,
                    verify: {
                        prevState: {}, counter: 0, issueMsg: "", showRetry: false
                    }
                },
                timeBeforeRetry: 5
            }
        },
        beforeRouteLeave (to, from, next) {
            if(!this.upload.showProgress || window.confirm('Leaving will cancel the upload. Do you really want to leave ?')) {
                next();
            } else {
                next(false);
            }
        },
        computed: {
            verifyBar() {
                var y = this.verify.verified;
                return { read: Math.min(Math.max(this.verify.read - y, 0), 100), verified: y };
            }
        },
        methods: {
            resetUpload() {
                this.upload.done = false;
                this.upload.msg = "";
                this.upload.showProgress = false;
                this.upload.blocks = [];
                this.upload.read = this.upload.acknowledged = this.upload.executed = this.upload.failed = 0;
                this.upload.verify.prevState = {};
                this.upload.verify.counter = 0;
                this.upload.verify.issueMsg = "";
                this.upload.verify.showRetry = false;
            },
            resetFile() {
                this.fileMsg = "";
                this.verify.done = false;
                this.verify.msg = "";
                this.verify.warnings = [];
                this.verify.isHashed = undefined;
                this.rowsCount = this.verify.read = this.verify.verified = 0;
                this.resetUpload();
            },
            csvFileChange(e) {
                this.resetFile();
                if(e.target && e.target.files && e.target.files.length == 1)
                    this.checkFile(e.target.files[0]);
                else
                    this.fileMsg = "Invalid choice, expecting one file";
            },
            onDrop(e) {
                this.resetFile();
                if(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length == 1)
                    this.checkFile(e.dataTransfer.files[0]);
                else
                    this.fileMsg = "Invalid drop, expecting one file";
            },
            checkFile(file) {
                if(file.type !== "text/csv" && file.type !== "application/vnd.ms-excel") {
                    this.fileMsg = "Unexpected file type '" + file.type + "', expecting 'text/csv'";
                }
                this.hasFile = true;
                this.file = file;
                this.verifyFile();
            },
            humanFileSize(size) {
                if(size <= 0) return "0 bytes";
                var i = Math.floor( Math.log(size) / Math.log(1024) );
                return ( size / Math.pow(1024, i) ).toFixed(2) * 1 + ' ' + ['Bytes', 'kB', 'MB', 'GB', 'TB'][i];
            },
            parseFile(onNewLine, onComplete, onError) {
                Papa.LocalChunkSize = 8192;
                Papa.parse(this.file, {
                    header: true,
                    trimHeaders: true,
                    step: onNewLine,
                    complete: onComplete,
                    error: onError,
                    skipEmptyLines: true
                });
            },
            verifyFile() {
                var self = this, leiBuff = [], hasFailed = false, tempWarnings = {};
                var checkBuff = function() {
                        let v = self.verify.read - self.verify.verified;
                        if(self.verify.verified == 0) {
                            let fieldCheck = MADRecUtils.verifyFieldNames(leiBuff[0]);
                            if(fieldCheck.success !== true) {
                                self.verify.msg = "Error on row 0, invalid field '" + fieldCheck.field + "'";
                                return false;
                            }
                        }
                        for(let i = 0; i < leiBuff.length; i++) {
                            let check = MADRecUtils.verifyData(leiBuff[i][MADRec.lei.name], leiBuff[i]);
                            if(check.success !== true) {
                                let row = (self.rowsCount - self.verify.blockSize + i + 2);
                                self.verify.msg = "Error with LEI '" + leiBuff[i][MADRec.lei.name] + "' on row " +
                                    row + " for field '" + check.field + "' with value '" + check.value + "'";
                                return false;
                            }
                            if(check.isHashed && self.verify.isHashed == undefined) self.verify.isHashed = true;
                            else if(check.isHashed && self.verify.isHashed == false) {
                                let row = (self.rowsCount - self.verify.blockSize + i + 2);
                                self.verify.msg = "Inconsistent hashing for LEI '" + leiBuff[i][MADRec.lei.name] + "' on row " + row;
                                return false;
                            }
                            if(check.warnings) {
                                for(let w in check.warnings) {
                                    if(tempWarnings[w] !== undefined) tempWarnings[w]++;
                                    else tempWarnings[w] = 1;
                                }
                            }
                            self.verify.verified += v / leiBuff.length;
                        }
                        self.verify.verified = self.verify.read;
                        return true;
                    },
                    onNewLine = function(row, parser) {
                        self.verify.read = row.meta.cursor * 100 / self.file.size;
                        leiBuff.push(row.data[0]);
                        if(leiBuff.length == self.verify.blockSize) {
                            if(!checkBuff()) {
                                parser.abort();
                                hasFailed = true;
                            }
                            leiBuff.length = 0;
                            self.verify.warnings = Object.keys(tempWarnings).map(x => { return x + (tempWarnings[x] > 1 ? " (" + tempWarnings[x] + " times)" : ""); });
                        }
                        self.rowsCount++;
                    },
                    onComplete = function() {
                        if(leiBuff.length > 0) {
                            if(!checkBuff()) {
                                hasFailed = true;
                            }
                            leiBuff.length = 0;
                            self.verify.warnings = Object.keys(tempWarnings).map(x => { return x + (tempWarnings[x] > 1 ? " (" + tempWarnings[x] + " times)" : ""); });
                        }
                        if(!hasFailed) {
                            self.verify.read = self.verify.verified = 100;
                            self.verify.done = true;
                        }
                    },
                    onError = function(e) {
                        self.verify.msg = "File reading error: " + e;
                    };
                this.parseFile(onNewLine, onComplete, onError);
            },
            updateUploadBlockState(id, state, msg = "") {
                this.upload.blocks[id].state = state;
                this.upload.blocks[id].class = this.progressColors[state];
                this.upload.blocks[id].title = msg || state;
            },
            async uploadBlock(leiBuff, blockId, hashOpt) {
                let args = [], items = leiBuff.length;
                for(let i = 0; i < leiBuff.length; i++) {
                    if(hashOpt < 3) MADRecUtils.verifyData(leiBuff[i][MADRec.lei.name], leiBuff[i]); // verify does transform
                    args.push(await MADRecUtils.rowToJson(leiBuff[i], hashOpt));
                }
                store.SCPs[MADRecNetwork]
                    .sendTx("madrec", "put-many", "madrec-multi-put-" + blockId, args)
                    .onError(x => {
                        this.updateUploadBlockState(blockId, "failed", x);
                        this.upload.failed += items;
                    })
                    .onAcknowledged(x => {
                        if(this.upload.blocks[blockId].state != "failed") {
                            this.updateUploadBlockState(blockId, "acknowledged");
                            this.upload.acknowledged += items;
                        }
                    })
                    .onExecuted(x => {
                        if(this.upload.blocks[blockId].state != "failed") {
                            this.updateUploadBlockState(blockId, "executed");
                            this.upload.executed += items;
                        }
                    });
            },
            uploadFile() {
                var self = this, leiBuff = [], hashOpt = $('#madrecMultiPutHash').val();
                if(hashOpt < 3 && this.verify.isHashed) {
                    this.upload.msg = "Your data is hashed, please select the 'Already hashed' option";
                    return;
                } else if(hashOpt == 3 && !this.verify.isHashed) {
                    this.upload.msg = "Your data is not hashed, can't send it with the 'Already hashed' option";
                    return;
                }
                this.resetUpload();
                this.upload.showProgress = true;
                let onNewLine = function(row, parser) {
                        self.upload.read++;
                        leiBuff.push(row.data[0]);
                        if(leiBuff.length == self.upload.blockSize) {
                            self.upload.blocks.push({ state: "sent", items: leiBuff.length, class: "bg-secondary", title: "loading" });
                            self.uploadBlock(leiBuff.slice(0), self.upload.blocks.length - 1, hashOpt);
                            leiBuff.length = 0;
                        }
                    },
                    onComplete = function() {
                        self.upload.read = self.rowsCount;
                        if(leiBuff.length > 0) {
                            self.upload.blocks.push({ state: "sent", items: leiBuff.length, class: "bg-secondary", title: "loading" });
                            self.uploadBlock(leiBuff.slice(0), self.upload.blocks.length - 1, hashOpt);
                            leiBuff.length = 0;
                        }
                        self.upload.verify.counter = 0;
                        self.upload.verify.issueMsg = "";
                        self.upload.verify.showRetry = false;
                        setTimeout(function() { self.verifyUpload(); }, 1600);
                    },
                    onError = function(e) {
                        self.upload.msg = "File reading error: " + e;
                    };
                this.parseFile(onNewLine, onComplete, onError);
            },
            verifyUpload() {
                let u = this.upload, self = this, v = u.verify;
                if(u.executed == this.rowsCount) {
                    u.msg = "Upload success";
                    u.showProgress = u.showRetry = false;
                    u.done = true;
                    v.issueMsg = "";
                    v.counter = 0;
                    return;
                }
                u.msg = "Uploading... " + u.executed + " / " + this.rowsCount + " LEIs done. ";
                if(v.prevState.read !== undefined) {
                    if(v.prevState.read == u.read && v.prevState.acknowledged == u.acknowledged &&
                    v.prevState.executed == u.executed && v.prevState.failed == u.failed) {
                        v.issueMsg = "It is taking more time than usual. Waiting a bit... ";
                        v.counter++;
                    } else {
                        v.counter = 0;
                        v.showRetry = false;
                    }
                }
                if((u.read == (u.executed + u.failed)) || v.counter > this.timeBeforeRetry) {
                    let c = "";
                    v.issueMsg = "There are ";
                    if(u.failed > 0) {
                        v.issueMsg += u.failed + " LEIs with errors";
                        c = ", ";
                    }
                    let unprocessed = u.acknowledged - u.failed - u.executed;
                    if(unprocessed > 0) {
                        v.issueMsg += c + unprocessed + " LEIs unprocessed";
                        c = ", ";
                    }
                    let unconfirmed = u.read - u.failed - u.acknowledged - u.executed;
                    if(unconfirmed > 0) {
                        v.issueMsg += c + unconfirmed + " LEIs unconfirmed";
                    }
                    v.issueMsg += ". Please try uploading these again.";
                    v.showRetry = true;
                }
                v.prevState = { read: u.read, acknowledged: u.acknowledged, executed: u.executed, failed: u.failed };
                setTimeout(function() { self.verifyUpload(); }, 1600);
            },
            retryMissing() {
                var toRetry = [], hashOpt = $('#madrecMultiPutHash').val();
                for (let i = 0; i < this.upload.blocks.length; i++) {
                    if(this.upload.blocks[i].state != "executed") {
                        toRetry.push(i);
                        this.upload[this.upload.blocks[i].state] -= this.upload.blockSize;
                    }
                }
                var self = this, leiBuff = [], blockId = 0,
                    onNewLine = function(row, parser) {
                        leiBuff.push(row.data[0]);
                        if(leiBuff.length == self.upload.blockSize) {
                            if(toRetry.includes(blockId)) {
                                self.updateUploadBlockState(blockId, "sent", "retrying");
                                self.uploadBlock(leiBuff.slice(0), blockId, hashOpt);
                            }
                            leiBuff.length = 0;
                            blockId++;
                        }
                    },
                    onComplete = function() {
                        if(leiBuff.length > 0 && toRetry.includes(blockId)) {
                            self.updateUploadBlockState(blockId, "sent", "retrying");
                            self.uploadBlock(leiBuff.slice(0), blockId, hashOpt);
                            leiBuff.length = 0;
                        }
                        self.upload.verify.counter = 0;
                        self.upload.verify.issueMsg = "";
                        setTimeout(function() { self.verifyUpload(); }, 1600);
                    },
                    onError = function(e) {
                        self.upload.msg = "File reading error: " + e;
                    };
                this.parseFile(onNewLine, onComplete, onError);
            }
        }
    });
    const MADRecAppReports = Vue.component('sec-madrec-report', {
        template: '#sec-madrec-report',
        data: function () {
            return {
                personalReport: [],
                personalReportChart: null,
                personalReportObjUrl: "",
                consortiumReport: [],
                consortiumReportChart: null,
                consortiumReportObjUrl: "",
                nsUserReport: new notifState(),
                nsConsortiumReport: new notifState(),
                download: {
                    started: false, done: false, start: 0, step: 100, cursor: 0, stopped: false,
                    msg: "", retries: 0, showRetry: false,
                    writeStream: null, writer: null, transformer: null, beforeClose: null
                }
            }
        },
        beforeMount: function() {
            this.nsUserReport.start("Loading ...", true);
            store.SCPs[MADRecNetwork]
                .sendQuery("madrec", "get-report", "madrec-get-report-user")
                .onError(x => {
                    this.nsUserReport.failed(x, true);
                    if(this.consortiumReportChart != null)
                        this.consortiumReportChart.clear();
                    this.personalReport = [];
                })
                .onResult(x => {
                    this.download.done = false;
                    this.nsUserReport.executed().hide(0);
                    this.personalReport = x;
                    setTimeout(() => { this.drawUserReport(x); }, 200);
                });

            this.nsConsortiumReport.start("Loading ...", true);
            store.SCPs[MADRecNetwork]
                .sendQuery("madrec", "get-report-consortium", "madrec-get-report-consortium")
                .onError(x => {
                    this.nsConsortiumReport.failed(x, true);
                    if(this.consortiumReportChart != null)
                        this.consortiumReportChart.clear();
                    this.consortiumReport = [];
                })
                .onResult(x => {
                    this.download.done = false;
                    this.nsConsortiumReport.executed().hide(0);
                    this.consortiumReport = x;
                    setTimeout(() => { this.drawConsortiumReport(x); }, 200);
                });
        },
        beforeDestroy() {
            URL.revokeObjectURL(this.personalReportObjUrl);
            URL.revokeObjectURL(this.consortiumReportObjUrl);
        },
        beforeRouteLeave (to, from, next) {
            if(!this.download.started || this.download.stopped || this.download.done ||
                    window.confirm('Leaving will cancel the download. Do you really want to leave ?')) {
                next();
            } else {
                next(false);
            }
        },
        computed: {
            personalReportExportUrl() {
                let json = JSON.stringify(this.personalReport, null, 4),
                    blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
                if(this.personalReportObjUrl != "") URL.revokeObjectURL(this.personalReportObjUrl);
                this.personalReportObjUrl = URL.createObjectURL(blob);
                return this.personalReportObjUrl;
            },
            consortiumReportExportUrl() {
                let json = JSON.stringify(this.consortiumReport, null, 4),
                    blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
                if(this.consortiumReportObjUrl != "") URL.revokeObjectURL(this.consortiumReportObjUrl);
                this.consortiumReportObjUrl = URL.createObjectURL(blob);
                return this.consortiumReportObjUrl;
            }
        },
        methods: {
            createChart(el, labels, datasets) {
                return new Chart(el, {
                    type: 'horizontalBar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            xAxes: [{ stacked: true }],
                            yAxes: [{ stacked: true, categoryPercentage: 0.5 }]
                        },
                        responsive: true,
                        maintainAspectRatio: false,
                        tooltips: { /*classic tooltip drawn into the canvas do not have enough space*/
                            enabled: false,
                            custom: function(m) {
                                var e = $('#chartjs-tooltip');
                                if(e.length == 0) e = $('<div id="chartjs-tooltip"><table style="line-height: 1;"></table></div>').appendTo('body');
                                if (m.opacity === 0) { e.css({"opacity": 0, display: "none" }); return; }
                                e.removeClass('above', 'below', 'no-transform');
                                if (m.yAlign) e.addClass(m.yAlign);
                                else e.addClass('no-transform');
                                if (m.body) {
                                    let innerHtml = '<thead>';
                                    (m.title || []).forEach(function(title) {
                                        innerHtml += '<tr><th>' + title + '</th></tr>';
                                    });
                                    innerHtml += '</thead><tbody>';
                                    m.body.map(x => x.lines).forEach(function(body, i) {
                                        let style = 'background:' + m.labelColors[i].backgroundColor +
                                            '; border: 1px solid rgba(255,255,255,.9); display: inline-block' +
                                            '; height: 10px; width: 10px; margin-right: 3px;';
                                        innerHtml += '<tr><td><span style="' + style + '"></span>' + body + '</td></tr>';
                                    });
                                    innerHtml += '</tbody>';
                                    e.find('table').html(innerHtml);
                                }
                                var position = this._chart.canvas.getBoundingClientRect();
                                e.css({
                                    opacity: 1, position: 'absolute', padding: '6px', display: "block",
                                    left: position.left + m.caretX + 'px', top: position.top + m.caretY + 'px',
                                    //fontFamily: m._bodyFontFamily, fontSize: m.bodyFontSize + 'px', fontStyle: m._bodyFontStyle,
                                    'background-color': 'rgba(0, 0, 0, .8)', 'border-radius': '4px', color: '#fff'
                                });
                            }
                        }
                    }
                });
            },
            drawUserReport(o) {
                let c = $('#madrec-user-report')[0];
                if(c === undefined) return;
                let sets = ["full consensus", "split consensus with majority", "no consensus", "split consensus with minority", "no match"],
                    colors = ["#218838", "#28a745", "#ffc107", "#fd7e14", "#dee2e6"],
                    fields = o.map(x => x.name), self = this;
                if(this.personalReportChart == null) {
                    let datasets = sets.map((z, i) => {
                        return { label: z, backgroundColor: colors[i], data: o.map(x => (x[z] || 0)) };
                    });
                    this.personalReportChart = this.createChart(c, fields, datasets);
                } else {
                    this.personalReportChart.data.labels = fields;
                    sets.map((z, i) => {
                        return self.personalReportChart.data.datasets[i].data = o.map(x => (x[z] || 0));
                    });
                }
                this.personalReportChart.canvas.parentNode.style.height = (70 + 16 * o.length) + "px";
                this.personalReportChart.update();
            },
            drawConsortiumReport(o) {
                let c = $('#madrec-consortium-report')[0];
                if(c === undefined) return;
                let sets = ["full consensus", "split consensus", "no consensus", "no match"],
                    colors = ["#218838", "#28a745", "#ffc107", "#dee2e6"],
                    fields = o.map(x => x.name + " (" + x.participants + ")"), self = this;
                if(this.consortiumReportChart == null) {
                    let datasets = sets.map((z, i) => {
                        return { label: z, backgroundColor: colors[i], data: o.map(x => (x[z] || 0)) };
                    });
                    this.consortiumReportChart = this.createChart(c, fields, datasets);
                } else {
                    this.consortiumReportChart.data.labels = fields;
                    sets.map((z, i) => {
                        return self.consortiumReportChart.data.datasets[i].data = o.map(x => (x[z] || 0));
                    });
                }
                this.consortiumReportChart.canvas.parentNode.style.height = (60 + 15 * o.length) + 'px';
                this.consortiumReportChart.update();
            },
            downloadNextBlock() {
                this.download.msg = "Streaming ... " + this.download.cursor + "/" + (this.download.cursor + this.download.step);
                store.SCPs[MADRecNetwork]
                    .sendQuery("madrec", "get-leis", "madrec-get-leis", { cursor: this.download.cursor, maxLEIs: this.download.step })
                    .onError(x => {
                        if(this.download.stopped) return;
                        if(this.download.retries++ == 3) {
                            this.download.msg += " failed after 3 retries (" + x + ")";
                            this.download.showRetry = true;
                            return;
                        }
                        this.downloadNextBlock();
                    })
                    .onResult(x => {
                        if(this.download.stopped) return;
                        if(x["LEI Codes"].length == 0 && !x.last) {
                            this.download.done = true;
                            this.download.msg = "Stream error, nothing retrieved in this block.";
                            return;
                        }
                        this.download.retries = 0;
                        this.download.showRetry = false;
                        this.download.writer.write(sec.utils.encode(this.download.transformer(x)));
                        this.download.cursor += x["LEI Codes"].length;
                        if(x.last) {
                            this.download.done = true;
                            this.download.msg = "Stream completed. " + (this.download.cursor - this.download.start) + " LEIs retrieved.";
                            if(this.download.beforeClose != null) {
                                this.download.beforeClose();
                            }
                            this.download.writer.close();
                        } else {
                            this.downloadNextBlock();
                        }
                    });
            },
            retry() {
                this.download.retries = 0;
                this.download.showRetry = false;
                this.download.msg = "Retrying ...";
                this.downloadNextBlock();
            },
            stop() {
                this.download.retries = 0;
                this.download.showRetry = false;
                this.download.stopped = true;
                this.download.msg = "Stream stopped. " + (this.download.cursor - this.download.start) + " LEIs retrieved.";
                if(this.download.beforeClose != null) {
                    this.download.beforeClose();
                }
                this.download.writer.close();
            },
            leisToCsv(x) {
                let rows = "";
                for(let lei of x["LEI Codes"]) {
                    MADRecUtils.fillReport(lei.fields);
                    let row = Array(1 + 4 * MADRec.fields.length).fill("");
                    row[0] = lei[MADRec.lei.name];
                    for(let f in lei.fields) {
                        let i = MADRecUtils.fieldsIndex[f], j = 1 + i * 4;
                        row[j] = f;
                        row[j+1] = lei.fields[f].total;
                        row[j+2] = "\"" + lei.fields[f].contribution + "\"";
                        row[j+3] = "\"" + lei.fields[f].report + "\"";
                    }
                    rows += row.join(",") + "\r\n";
                }
                return rows;
            },
            leisToJson(x) {
                let rows = "", addComma = this.download.cursor != 0;
                for(let lei of x["LEI Codes"]) {
                    MADRecUtils.fillReport(lei.fields);
                    if(addComma)
                        rows += ",";
                    else
                        addComma = true;
                    rows += "\r\n  " + JSON.stringify(lei);
                }
                return rows;
            },
            startDownload() {
                let cursor = parseInt($("#madrec-leis-report-cursor").val(), 10) || 0,
                    step = parseInt($("#madrec-leis-report-step").val(), 10) || 100;
                this.download.start = this.download.cursor = cursor;
                this.download.step = step;
                this.download.started = true;
                this.download.stopped = this.download.done = false;
                this.download.msg = "Starting ...";
                this.downloadNextBlock();
            },
            downloadAsCsv() {
                this.download.writeStream = streamSaver.createWriteStream('leis-report.csv');
                this.download.writer = this.download.writeStream.getWriter();
                this.download.transformer = this.leisToCsv;
                this.download.beforeClose = null;

                let header = MADRec.lei.name;
                for(let f of MADRec.fields) {
                    header += ",name,total,contribution,report";
                }
                this.download.writer.write(sec.utils.encode(header + "\r\n"));
                this.startDownload();
            },
            downloadAsJson() {
                this.download.writeStream = streamSaver.createWriteStream('leis-report.json');
                this.download.writer = this.download.writeStream.getWriter();
                this.download.transformer = this.leisToJson;
                this.download.beforeClose = () => {
                    this.download.writer.write(sec.utils.encode("\r\n}"));
                };

                this.download.writer.write(sec.utils.encode("{"));
                this.startDownload();
            }
        }
    });
    const PieChart = Vue.component('pie-chart', {
        template: "#sec-pie-chart",
        mounted() {
            this.anim = 0;
            setTimeout(() => this.animate(), 0);
        },
        props: ['data', 'colors'],
        data() {
            return {
                radius: 42,
                width: 14,
                space: 0.06,
                anim: 0
            }
        },
        computed: {
            total() {
                this.anim = 0;
                setTimeout(() => this.animate(), 10);
                return this.data.reduce((previous, current) => previous + current);
            },
            items() {
                let offset = -0.25, r = this.radius, w = r - this.width;
                return this.data.map((item, i) => {
                    let sz = Math.sin(this.anim * Math.PI / 2) * item / this.total,
                        d1 = offset * 2 * Math.PI, cd1 = Math.cos(d1), sd1 = Math.sin(d1),
                        d2 = (offset + sz) * 2 * Math.PI,
                        x1 = r + r * cd1, y1 = r + r * sd1,
                        x2 = r + r * Math.cos(d2 - this.space * w / r), y2 = r + r * Math.sin(d2 - this.space * w / r),
                        x3 = r + w * Math.cos(d2 - this.space), y3 = r + w * Math.sin(d2 - this.space),
                        x4 = r + w * cd1, y4 = r + w * sd1,
                        f = sz > .5 ? 1 : 0;
                    offset += sz;
                    return {
                        path: `M ${x1},${y1} A ${r},${r} 0,${f},1 ${x2} ${y2} L ${x3},${y3} A ${w},${w} 0,${f},0 ${x4} ${y4} z`,
                        color: this.colors[i],
                        text: {
                            x: sz < 0.1 ? 0 : (r + (r - this.width / 2) * Math.cos((d1 + d2) / 2) - 2.5),
                            y: sz < 0.1 ? 0 : (r + (r - this.width / 2) * Math.sin((d1 + d2) / 2) + 2.5),
                            value: sz < 0.1 ? "" : item
                        }
                    };
                })
            }
        },
        methods: {
            animate() {
                if(this.anim < 1) {
                    this.anim += 0.02;
                    setTimeout(() => this.animate(), 10);
                }
            }
        }
    });
    router.addRoutes([
        { path: '/madrec', component: MADRecApp,
            children: [
                { path: '', redirect: 'single-lei' },
                { path: 'members', component: MADRecAppMembers },
                { path: 'single-lei', component: MADRecAppSingleLEI, meta: { dcappName: "MADRec" } },
                { path: 'multi-lei', component: MADRecAppMultiLEI },
                { path: 'reports', component: MADRecAppReports }
            ]
        }
    ]);
</script>